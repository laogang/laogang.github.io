# 领域驱动设计

[TOC]

```txt
领域驱动设计（Domain-driven design，缩写 DDD）是一种通过将实现连接到持续进化的模型来满足复杂需求的软件开发方法。
```

## 设计领域模型的一般步骤如下

```txt
1）根据需求划分出初步的领域和限界上下文，以及上下文之间的关系；
2）进一步分析每个上下文内部，识别出哪些是实体，哪些是值对象；
3）对实体、值对象进行关联和聚合，划分出聚合的范畴和聚合根；
4）为聚合根设计仓储，并思考实体或值对象的创建方式；
5）在工程中实践领域模型，并在实践中检验模型的合理性，倒推模型中不足的地方并重构。
```

## 区分实体、值对象和领域服务

```txt
 在DDD中，领域模型分为三种： 实体，值对象，领域服务。
 
   我们不打算去解释以上的概念，我相信只要你搜索一下就可以得到很全面准确的答案。但是重要的是我们一定要理解3者之间的区别，什么时候是实体，什么时候是值对象，又是什么时候我们该用领域服务呢？我想这是刚接触DDD的人都难免会有些纠结的地方吧，在这里就强调一下。

　  实体相对于值对象而言拥有“标识”的概念，标识可以让我们持续性的跟踪实体。标识和数据库里面的“主键”是不一样的概念，主键是技术上的概念，但是标识是业务上的概念。

　　在我们上面的例子中用户ID是标识，我们用它来持续性的跟踪我们的用户。订单ID是标识，我们用它来持续性的跟踪订单，同时我们的用户和订单都是有着不同的状态。但是对于用户的地址来说，我们用什么来做标识呢？在电子商务网站这样的业务里面，我们不需要去持续的跟踪这个地址信息，它在我们的系统里面也不会有着像订单从“创建”、“已付款”、“已发货”、“已收货”等这样的状态，所以地址信息的在我们系统中就是一个值对象。

　　但是我们如果换了一个系统，比如说死慢的长城宽带，他们把地址作为跟踪对象。同一个地址，谁都可以去注册，但是同一个时间只允许一个人去注册，那么这个地址对于长城宽带来说就去要去持续性的跟踪，有“开户”，“销户”的状态。那么地址信息对于长城宽带来说就是一个实体。

　　解决完实体和值对象，领域服务就好说了，一些重要的领域操作，既不属于实体也不属于值对象，那就可以把它放到服务中了。比如说我们上面的领域服务UserService里面的注册操作，注册这个操作可以说就是将这个用户保存到我们的系统中。在注册之前，这个用户是不存在的，我们又怎么能把注册这个操作放到User实体中去呢？所以把它放到领域服务中成了我们最好的选择。

　　即使是这样，哪些操作应该放到领域服务中对于很多初学者来说还是一件比较难选择的问题。也许只有慢慢的对业务越来越了解，对DDD应用的越来越熟，我们就会少一点纠结。
```

## 厘清业务主次-聚合与聚合根

```txt
　  在我们的模型中，购物车-购物车项是一个聚合，订单-订单项是一个聚合。我们通常需要保护这些聚合的一致性，比如说我们把一个订单删掉了，那么这个订单的订单项也需要一起删除，否则他们存在也没有任何的意义。以前我们还会用到触发器，但是大家都知道这个东西维护起来比较麻烦，写起来也不方便等，所以后来大家都是在代码中来控制。但是一直没有一个好的约束说我们如何去更好的控制这些一致性，代码一直都很散乱，直到DDD，我们有了聚合和聚合根的概念，“我们通过为每一个聚合选择一个根，并通过根来控制所有对边界内的对象的访问。外部对象只能持有根的引用；由于根控制了访问，因此我们无法绕过它去修改内部元素。我们后面还会说到只能为根来建立Repository，这也是为了确保我们这里面讲的数据的一致性。
```

